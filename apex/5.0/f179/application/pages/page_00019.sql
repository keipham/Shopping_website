prompt --application/pages/page_00019beginwwv_flow_api.create_page( p_id=>19,p_user_interface_id=>wwv_flow_api.id(327304041051455600),p_name=>'U_ User order details',p_page_mode=>'MODAL',p_step_title=>'User order details',p_step_sub_title_type=>'TEXT_WITH_SUBSTITUTIONS',p_first_item=>'NO_FIRST_ITEM',p_autocomplete_on_off=>'OFF',p_javascript_code=>'var htmldb_delete_message=''"DELETE_CONFIRM_MSG"'';',p_inline_css=>wwv_flow_string.join(wwv_flow_t_varchar2('','body{','    font-family: ''Comic Sans MS'';','}')),p_page_template_options=>'#DEFAULT#',p_required_role=>wwv_flow_api.id(328321042163774142),p_dialog_chained=>'Y',p_overwrite_navigation_list=>'N',p_page_is_public_y_n=>'N',p_protection_level=>'C',p_cache_mode=>'NOCACHE',p_last_updated_by=>'defaultUser',p_last_upd_yyyymmddhh24miss=>'20000101000000');wwv_flow_api.create_page_plug( p_id=>wwv_flow_api.id(348451255701546604),p_plug_name=>'Form on SOK_ORDER_CONTENT_DETAIL_VW',p_region_template_options=>'#DEFAULT#',p_plug_template=>wwv_flow_api.id(327260456234455539),p_plug_display_sequence=>10,p_include_in_reg_disp_sel_yn=>'N',p_plug_display_point=>'BODY',p_plug_query_row_template=>1,p_attribute_01=>'N',p_attribute_02=>'TEXT',p_attribute_03=>'Y');wwv_flow_api.create_page_plug( p_id=>wwv_flow_api.id(348451915221546607),p_plug_name=>'Buttons',p_region_template_options=>'#DEFAULT#',p_plug_template=>wwv_flow_api.id(327260825035455539),p_plug_display_sequence=>10,p_include_in_reg_disp_sel_yn=>'N',p_plug_display_point=>'REGION_POSITION_03',p_plug_query_row_template=>1,p_attribute_01=>'N',p_attribute_02=>'TEXT',p_attribute_03=>'Y');wwv_flow_api.create_page_button( p_id=>wwv_flow_api.id(348452387720546607),p_button_sequence=>10,p_button_plug_id=>wwv_flow_api.id(348451915221546607),p_button_name=>'CANCEL',p_button_action=>'DEFINED_BY_DA',p_button_template_options=>'#DEFAULT#',p_button_template_id=>wwv_flow_api.id(327293267790455585),p_button_image_alt=>'Cancel',p_button_position=>'REGION_TEMPLATE_CLOSE',p_warn_on_unsaved_changes=>null);wwv_flow_api.create_page_button( p_id=>wwv_flow_api.id(382699237107986092),p_button_sequence=>40,p_button_plug_id=>wwv_flow_api.id(348451915221546607),p_button_name=>'DELETE',p_button_action=>'REDIRECT_URL',p_button_template_options=>'#DEFAULT#',p_button_template_id=>wwv_flow_api.id(327293267790455585),p_button_image_alt=>'Delete',p_button_position=>'REGION_TEMPLATE_DELETE',p_button_redirect_url=>'javascript:apex.confirm(htmldb_delete_message,''DELETE'');',p_button_execute_validations=>'N',p_button_condition=>wwv_flow_string.join(wwv_flow_t_varchar2('select oc.order_id, SUM(oc.order_product_quantity)  ','from SOK_ORDER_CONTENT oc','inner join SOK_ORDER o','on oc.order_id = o.order_id','where oc.order_id = :P19_ORDER_ID  and o.order_status_code = ''PAID''','having SUM(oc.order_product_quantity)>1','group by oc.order_id')),p_button_condition_type=>'EXISTS',p_database_action=>'DELETE');wwv_flow_api.create_page_button( p_id=>wwv_flow_api.id(348451772729546607),p_button_sequence=>30,p_button_plug_id=>wwv_flow_api.id(348451915221546607),p_button_name=>'SAVE',p_button_action=>'SUBMIT',p_button_template_options=>'#DEFAULT#',p_button_template_id=>wwv_flow_api.id(327293267790455585),p_button_is_hot=>'Y',p_button_image_alt=>'Save',p_button_position=>'REGION_TEMPLATE_NEXT',p_button_condition=>'P19_ORDER_ID',p_button_condition_type=>'ITEM_IS_NOT_NULL');wwv_flow_api.create_page_item( p_id=>wwv_flow_api.id(345822027813557546),p_name=>'P19_PRODUCT_DETAIL_ID',p_item_sequence=>20,p_item_plug_id=>wwv_flow_api.id(348451255701546604),p_display_as=>'NATIVE_HIDDEN',p_protection_level=>'S',p_attribute_01=>'Y');wwv_flow_api.create_page_item( p_id=>wwv_flow_api.id(348454736478546615),p_name=>'P19_ORDER_ID',p_item_sequence=>10,p_item_plug_id=>wwv_flow_api.id(348451255701546604),p_use_cache_before_default=>'NO',p_prompt=>'Order Id',p_source=>'ORDER_ID',p_source_type=>'DB_COLUMN',p_display_as=>'NATIVE_HIDDEN',p_label_alignment=>'RIGHT',p_field_template=>wwv_flow_api.id(327292794678455582),p_item_template_options=>'#DEFAULT#',p_protection_level=>'S',p_attribute_01=>'Y');wwv_flow_api.create_page_item( p_id=>wwv_flow_api.id(348455116871546656),p_name=>'P19_ORDER_PRODUCT_QUANTITY',p_is_required=>true,p_item_sequence=>50,p_item_plug_id=>wwv_flow_api.id(348451255701546604),p_use_cache_before_default=>'NO',p_prompt=>'Quantity',p_source=>'ORDER_PRODUCT_QUANTITY',p_source_type=>'DB_COLUMN',p_display_as=>'NATIVE_NUMBER_FIELD',p_cSize=>32,p_cMaxlength=>255,p_field_template=>wwv_flow_api.id(327292952744455582),p_item_template_options=>'#DEFAULT#',p_attribute_03=>'right');wwv_flow_api.create_page_item( p_id=>wwv_flow_api.id(351683889392319205),p_name=>'P19_USER_ID',p_item_sequence=>30,p_item_plug_id=>wwv_flow_api.id(348451255701546604),p_display_as=>'NATIVE_HIDDEN',p_protection_level=>'S',p_attribute_01=>'Y');wwv_flow_api.create_page_item( p_id=>wwv_flow_api.id(387939897441254726),p_name=>'P19_PRODUCT_STOCK',p_item_sequence=>40,p_item_plug_id=>wwv_flow_api.id(348451255701546604),p_prompt=>'Availability',p_display_as=>'NATIVE_DISPLAY_ONLY',p_field_template=>wwv_flow_api.id(327292794678455582),p_item_template_options=>'#DEFAULT#',p_help_text=>'This does not include the quantity initially ordered.',p_attribute_01=>'N',p_attribute_02=>'VALUE',p_attribute_04=>'Y');wwv_flow_api.create_page_computation( p_id=>wwv_flow_api.id(386988701730327711),p_computation_sequence=>20,p_computation_item=>'P19_PRODUCT_STOCK',p_computation_point=>'AFTER_HEADER',p_computation_type=>'QUERY',p_computation=>wwv_flow_string.join(wwv_flow_t_varchar2('select distinct CASE ','                    WHEN product_detail_stock < 1 THEN ''Out of stock(''||product_detail_stock||'')'' ','                    WHEN product_detail_stock > 0 THEN ''In stock (''||product_detail_stock||'')'' ','                END AS Availability ','from SOK_PRODUCT_DETAIL_LIST_VW','where product_detail_id = :P19_PRODUCT_DETAIL_ID')));wwv_flow_api.create_page_computation( p_id=>wwv_flow_api.id(351683942974319206),p_computation_sequence=>10,p_computation_item=>'P19_USER_ID',p_computation_point=>'BEFORE_BOX_BODY',p_computation_type=>'QUERY',p_computation=>'select distinct user_id from SOK_USER_ROLE_VW where user_email = upper(:APP_USER)');wwv_flow_api.create_page_validation( p_id=>wwv_flow_api.id(386988845940327712),p_validation_name=>'Check if quantity is not negative or null',p_validation_sequence=>10,p_validation=>wwv_flow_string.join(wwv_flow_t_varchar2('begin','  if :P19_ORDER_PRODUCT_QUANTITY <= 0  then','    return false;','  else ','    return true;','  end if;','exception when others then','  logger.log_error(''Validation process "Check ordered quantity is not null or negative" failed. ''||SQLERRM);','end;')),p_validation_type=>'FUNC_BODY_RETURNING_BOOLEAN',p_error_message=>'The quantity cannot be null or negative. Thank you.',p_always_execute=>'Y',p_error_display_location=>'INLINE_WITH_FIELD_AND_NOTIFICATION');wwv_flow_api.create_page_validation( p_id=>wwv_flow_api.id(350593863327256850),p_validation_name=>'Check product_stock',p_validation_sequence=>20,p_validation=>wwv_flow_string.join(wwv_flow_t_varchar2('declare','  loc_product_stock               SOK_PRODUCT_DETAIL_LU.product_detail_stock%TYPE;','  loc_order_product_quantity      SOK_PRODUCT_DETAIL_LU.product_detail_stock%TYPE;','begin','  select distinct a.product_detail_stock','  into loc_product_stock','  from SOK_PRODUCT_DETAIL_LIST_VW a','  where a.product_detail_id = :P19_PRODUCT_DETAIL_ID;','  ','  select distinct order_product_quantity ','  into loc_order_product_quantity ','  from SOK_ORDER_CONTENT_DETAIL_VW ','  where order_id = :P19_ORDER_ID and product_detail_id = :P19_PRODUCT_DETAIL_ID;','  ','  --if :P19_ORDER_PRODUCT_QUANTITY > loc_product_stock and :P19_ORDER_PRODUCT_QUANTITY > loc_order_product_quantity then','  if :P19_ORDER_PRODUCT_QUANTITY > loc_product_stock+loc_order_product_quantity then','    return false;','  --elsif :P19_ORDER_PRODUCT_QUANTITY <= loc_order_product_quantity then','    --return true;','  else ','    return true;','  end if;','exception when others then','  logger.log_error(''Validation process "Check product stock" failed. ''||SQLERRM);','end;')),p_validation_type=>'FUNC_BODY_RETURNING_BOOLEAN',p_error_message=>'Oops ! There isn''t enough product in stock. Please try again later. Thank you.',p_always_execute=>'Y',p_error_display_location=>'INLINE_WITH_FIELD_AND_NOTIFICATION');wwv_flow_api.create_page_validation( p_id=>wwv_flow_api.id(351687876583319245),p_validation_name=>'Check if selected product is not the last one of the order',p_validation_sequence=>30,p_validation=>wwv_flow_string.join(wwv_flow_t_varchar2('declare','  loc_sum_order_quantity   SOK_ORDER_CONTENT.order_product_quantity%TYPE;','begin','  select SUM(order_product_quantity)','  into loc_sum_order_quantity','  from SOK_ORDER_CONTENT ','  where order_id = :P19_ORDER_ID;','  ','  loc_sum_order_quantity := loc_sum_order_quantity-:P19_ORDER_PRODUCT_QUANTITY;','  if loc_sum_order_quantity < 1 then','    return false;','  else ','    return true;','  end if;','end;')),p_validation_type=>'FUNC_BODY_RETURNING_BOOLEAN',p_error_message=>'Your order needs to contain at least one product. Otherwise, please cancel it.',p_always_execute=>'N',p_validation_condition_type=>'NEVER',p_when_button_pressed=>wwv_flow_api.id(382699237107986092),p_error_display_location=>'INLINE_WITH_FIELD_AND_NOTIFICATION');wwv_flow_api.create_page_da_event( p_id=>wwv_flow_api.id(348452442641546607),p_name=>'Cancel Dialog',p_event_sequence=>10,p_triggering_element_type=>'BUTTON',p_triggering_button_id=>wwv_flow_api.id(348452387720546607),p_bind_type=>'bind',p_bind_event_type=>'click');wwv_flow_api.create_page_da_action( p_id=>wwv_flow_api.id(348453278439546610),p_event_id=>wwv_flow_api.id(348452442641546607),p_event_result=>'TRUE',p_action_sequence=>10,p_execute_on_page_init=>'N',p_action=>'NATIVE_DIALOG_CANCEL',p_stop_execution_on_error=>'Y');wwv_flow_api.create_page_process( p_id=>wwv_flow_api.id(348456598517546662),p_process_sequence=>30,p_process_point=>'AFTER_SUBMIT',p_process_type=>'NATIVE_PLSQL',p_process_name=>'Process on update order content',p_process_sql_clob=>wwv_flow_string.join(wwv_flow_t_varchar2('declare','  loc_product_stock             SOK_PRODUCT_DETAIL_LU.product_detail_stock%TYPE;','  loc_order_product_quantity    SOK_PRODUCT_DETAIL_LU.product_detail_stock%TYPE;','  loc_size_range_code           SOK_PRODUCT_DETAIL_LU.size_range_code%TYPE;','  loc_sex_code                  SOK_PRODUCT_DETAIL_LU.sex_code%TYPE;','begin','  select distinct product_detail_stock, size_range_code, sex_code','  into loc_product_stock, loc_size_range_code, loc_sex_code','  from SOK_PRODUCT_DETAIL_LIST_VW ','  where product_detail_id = :P19_PRODUCT_DETAIL_ID;','  ','  select distinct order_product_quantity','  into loc_order_product_quantity','  from SOK_ORDER_CONTENT_DETAIL_VW','  where order_id = :P19_ORDER_ID and product_detail_id = :P19_product_detail_id;','  ','  --I update order content','  SOK_ORDER_CONTENT_UTIL.u_order_content (','     val_order_id => :P19_ORDER_ID,','     val_product_detail_id => :P19_product_detail_id,','     val_order_product_quantity => :P19_ORDER_PRODUCT_QUANTITY);',' ','','  if :P19_ORDER_PRODUCT_QUANTITY <= (loc_order_product_quantity+loc_product_stock) then','  --I update the product product detail stock','      logger.log(''je passe dans le if'');','      SOK_PRODUCT_DETAIL_UTIL.u_product_detail (','                                  val_product_detail_id => :P19_product_detail_id,','                                  val_size_range_code => loc_size_range_code,','                                  val_sex_code => loc_sex_code,','                                  val_product_detail_stock => loc_product_stock+to_number(loc_order_product_quantity-:P19_ORDER_PRODUCT_QUANTITY));','','   ','   ','  end if;','exception when others then','  logger.log_error(''Process "update order content" failed. ''||SQLERRM);','end;','')),p_error_display_location=>'INLINE_IN_NOTIFICATION',p_process_when_button_id=>wwv_flow_api.id(348451772729546607),p_process_success_message=>'Action Processed.');wwv_flow_api.create_page_process( p_id=>wwv_flow_api.id(351683789111319204),p_process_sequence=>40,p_process_point=>'AFTER_SUBMIT',p_process_type=>'NATIVE_PLSQL',p_process_name=>'Process on delete order content',p_process_sql_clob=>wwv_flow_string.join(wwv_flow_t_varchar2('declare','  --loc_count_product_detail SOK_ORDER_CONTENT.product_detail_id%TYPE;','begin','  SOK_ORDER_CONTENT_UTIL.d_order_content_product (','    val_order_id => :P19_ORDER_ID,','    val_product_detail_id => :P19_PRODUCT_DETAIL_ID);','/*','  --If the last product_detail of the order is destroyed then the order is automatically cancelled.','  select count(product_detail_id) into loc_count_product_detail','  from SOK_ORDER_CONTENT ','  where order_id = :P19_ORDER_ID;','  ','  if loc_count_product_detail = null or loc_count_product_detail = 0 then','    SOK_ORDER_UTIL.u_order (','      val_order_id => :P19_ORDER_ID,','      val_user_id => :P19_USER_ID,','      val_order_status_code => ''CANCELLED'');','  end if;*/','end;')),p_error_display_location=>'INLINE_IN_NOTIFICATION',p_process_when_button_id=>wwv_flow_api.id(382699237107986092),p_process_success_message=>'Action Processed.');wwv_flow_api.create_page_process( p_id=>wwv_flow_api.id(348457010215546664),p_process_sequence=>50,p_process_point=>'AFTER_SUBMIT',p_process_type=>'NATIVE_SESSION_STATE',p_process_name=>'reset page',p_attribute_01=>'CLEAR_CACHE_CURRENT_PAGE',p_error_display_location=>'INLINE_IN_NOTIFICATION');wwv_flow_api.create_page_process( p_id=>wwv_flow_api.id(351718103029392959),p_process_sequence=>70,p_process_point=>'AFTER_SUBMIT',p_process_type=>'NATIVE_CLOSE_WINDOW',p_process_name=>'Close Dialog - UPDATE',p_error_display_location=>'INLINE_IN_NOTIFICATION',p_process_when_button_id=>wwv_flow_api.id(348451772729546607),p_process_success_message=>'Your order has been successfully edited.');wwv_flow_api.create_page_process( p_id=>wwv_flow_api.id(351683993765319207),p_process_sequence=>80,p_process_point=>'AFTER_SUBMIT',p_process_type=>'NATIVE_CLOSE_WINDOW',p_process_name=>'Close Dialog - DELETE ',p_error_display_location=>'INLINE_IN_NOTIFICATION',p_process_when_button_id=>wwv_flow_api.id(382699237107986092),p_process_success_message=>'Your order has been successfully deleted.');wwv_flow_api.create_page_process( p_id=>wwv_flow_api.id(348456247707546662),p_process_sequence=>10,p_process_point=>'BEFORE_HEADER',p_process_type=>'NATIVE_FORM_FETCH',p_process_name=>'Fetch Row from SOK_ORDER_CONTENT',p_attribute_02=>'SOK_ORDER_CONTENT',p_attribute_03=>'P19_PRODUCT_DETAIL_ID',p_attribute_04=>'PRODUCT_DETAIL_ID',p_attribute_05=>'P19_ORDER_ID',p_attribute_06=>'ORDER_ID',p_error_display_location=>'INLINE_IN_NOTIFICATION');end;/