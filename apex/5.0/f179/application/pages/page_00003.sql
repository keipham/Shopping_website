prompt --application/pages/page_00003beginwwv_flow_api.create_page( p_id=>3,p_user_interface_id=>wwv_flow_api.id(327304041051455600),p_name=>'Shopping cart',p_page_mode=>'NORMAL',p_step_title=>'Shopping cart',p_step_sub_title_type=>'TEXT_WITH_SUBSTITUTIONS',p_first_item=>'NO_FIRST_ITEM',p_autocomplete_on_off=>'OFF',p_javascript_code=>wwv_flow_string.join(wwv_flow_t_varchar2('function deleteRow(value){','    if (confirm(''Would you like to delete this row?'')) {','        // Delete it!','        apex.item(''P3_REMOVE_ID'').setValue(value);','        apex.event.trigger(''#P3_REMOVE_ID'', ''Link_Call'', '''');','    } else {','        // Do nothing!','    }','}')),p_inline_css=>wwv_flow_string.join(wwv_flow_t_varchar2('body{','    font-family: ''Comic Sans MS'';','}')),p_page_template_options=>'#DEFAULT#',p_overwrite_navigation_list=>'N',p_page_is_public_y_n=>'Y',p_cache_mode=>'NOCACHE',p_last_updated_by=>'defaultUser',p_last_upd_yyyymmddhh24miss=>'20000101000000');wwv_flow_api.create_page_plug( p_id=>wwv_flow_api.id(344814941748650212),p_plug_name=>'My shopping cart',p_region_template_options=>'#DEFAULT#',p_plug_template=>wwv_flow_api.id(327269938950455546),p_plug_display_sequence=>21,p_include_in_reg_disp_sel_yn=>'Y',p_plug_display_point=>'BODY',p_plug_source=>wwv_flow_string.join(wwv_flow_t_varchar2('select a.seq_id,','       decode(nvl(dbms_lob.getlength(PRODUCT_IMAGE),0),0,null,','''<img src="'' || APEX_UTIL.GET_BLOB_FILE_SRC (''P5_PRODUCT_IMAGE'',d.product_id) || ''" height="75" width="75" />'') as "Image",','       a.c001 as "Name",','       c.sex_name as "Sex",','       a.n001 as "Product_id",','       b.size_lower_value||''-''||b.size_higher_value as size_range,','       a.n004 as "Quantity",','       a.n005 as "Price",','       ''''Remove_id','from APEX_COLLECTIONS a','inner join SOK_SIZE_RANGE_LU b','on b.size_range_code = a.n002 ','inner join SOK_SEX_TYPE_LU c','on c.sex_code = a.c002','inner join SOK_PRODUCT_LU d','on d.product_id = a.n001','where collection_name = ''MY_SOCK_COLLECTION''','order by "Name" asc;','','')),p_plug_source_type=>'NATIVE_IR',p_plug_query_options=>'DERIVED_REPORT_COLUMNS',p_prn_content_disposition=>'ATTACHMENT',p_prn_document_header=>'APEX',p_prn_units=>'INCHES',p_prn_paper_size=>'LETTER',p_prn_width=>8.5,p_prn_height=>11,p_prn_orientation=>'HORIZONTAL',p_prn_page_header_font_color=>'#000000',p_prn_page_header_font_family=>'Helvetica',p_prn_page_header_font_weight=>'normal',p_prn_page_header_font_size=>'12',p_prn_page_footer_font_color=>'#000000',p_prn_page_footer_font_family=>'Helvetica',p_prn_page_footer_font_weight=>'normal',p_prn_page_footer_font_size=>'12',p_prn_header_bg_color=>'#9bafde',p_prn_header_font_color=>'#000000',p_prn_header_font_family=>'Helvetica',p_prn_header_font_weight=>'normal',p_prn_header_font_size=>'10',p_prn_body_bg_color=>'#efefef',p_prn_body_font_color=>'#000000',p_prn_body_font_family=>'Helvetica',p_prn_body_font_weight=>'normal',p_prn_body_font_size=>'10',p_prn_border_width=>.5,p_prn_page_header_alignment=>'CENTER',p_prn_page_footer_alignment=>'CENTER');wwv_flow_api.create_worksheet( p_id=>wwv_flow_api.id(344818462117650247),p_max_row_count=>'1000000',p_show_nulls_as=>'-',p_pagination_type=>'ROWS_X_TO_Y',p_pagination_display_pos=>'BOTTOM_RIGHT',p_report_list_mode=>'TABS',p_show_detail_link=>'C',p_show_notify=>'Y',p_download_formats=>'CSV:HTML:EMAIL:XLS:PDF:RTF',p_detail_link=>'f?p=&APP_ID.:2:&SESSION.::&DEBUG.:RP,2:P2_MEMBER_SQ,P2_PRODUCT_ID:#SEQ_ID#,#Product_id#',p_detail_link_text=>'<img src="#IMAGE_PREFIX#app_ui/img/icons/apex-edit-pencil.png" class="apex-edit-pencil" alt="">',p_owner=>'KPQ',p_internal_uid=>344819072117650247);wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(344818504484650248),p_db_column_name=>'SEQ_ID',p_display_order=>10,p_column_identifier=>'A',p_column_label=>'Seq id',p_column_type=>'NUMBER',p_display_text_as=>'HIDDEN');wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(344818613019650249),p_db_column_name=>'Name',p_display_order=>20,p_column_identifier=>'B',p_column_label=>'Name',p_column_type=>'STRING',p_column_alignment=>'CENTER');wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(344818745238650250),p_db_column_name=>'Sex',p_display_order=>30,p_column_identifier=>'C',p_column_label=>'Sex',p_column_type=>'STRING',p_column_alignment=>'CENTER');wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(345153239816925401),p_db_column_name=>'Product_id',p_display_order=>40,p_column_identifier=>'D',p_column_label=>'Product id',p_column_type=>'NUMBER',p_display_text_as=>'HIDDEN');wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(345153462963925403),p_db_column_name=>'Quantity',p_display_order=>60,p_column_identifier=>'F',p_column_label=>'Quantity',p_column_type=>'NUMBER',p_column_alignment=>'CENTER');wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(345153562684925404),p_db_column_name=>'Price',p_display_order=>70,p_column_identifier=>'G',p_column_label=>'Price(â‚¬)',p_column_type=>'NUMBER',p_column_alignment=>'CENTER');wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(345155995352925429),p_db_column_name=>'Image',p_display_order=>110,p_column_identifier=>'L',p_column_label=>'Image',p_column_link=>'f?p=&APP_ID.:6:&SESSION.::&DEBUG.:RP,6:P6_PRODUCT_ID:#Product_id#',p_column_linktext=>'#Image#',p_column_type=>'STRING',p_display_text_as=>'WITHOUT_MODIFICATION',p_column_alignment=>'CENTER',p_format_mask=>'PCT_GRAPH:::');wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(345156162104925430),p_db_column_name=>'REMOVE_ID',p_display_order=>120,p_column_identifier=>'M',p_column_label=>'Remove ',p_column_link=>'javascript:deleteRow(''#SEQ_ID#'');',p_column_linktext=>'<span class="fa fa-remove" aria-hidden="true"></span>',p_column_type=>'STRING',p_column_alignment=>'CENTER');wwv_flow_api.create_worksheet_column( p_id=>wwv_flow_api.id(345158080469925449),p_db_column_name=>'SIZE_RANGE',p_display_order=>130,p_column_identifier=>'N',p_column_label=>'Size range',p_column_type=>'STRING',p_column_alignment=>'CENTER');wwv_flow_api.create_worksheet_rpt( p_id=>wwv_flow_api.id(345166586097947271),p_application_user=>'APXWS_DEFAULT',p_report_seq=>10,p_report_alias=>'3451672',p_status=>'PUBLIC',p_is_default=>'Y',p_display_rows=>50,p_view_mode=>'REPORT',p_report_columns=>'Name:Sex:SIZE_RANGE:Image:Quantity:Price:REMOVE_ID:',p_sum_columns_on_break=>'Price',p_flashback_enabled=>'N');wwv_flow_api.create_page_plug( p_id=>wwv_flow_api.id(345820694499557533),p_plug_name=>'Breadcrumb',p_region_template_options=>'#DEFAULT#:t-BreadcrumbRegion--useBreadcrumbTitle',p_component_template_options=>'#DEFAULT#',p_plug_template=>wwv_flow_api.id(327274899983455556),p_plug_display_sequence=>10,p_include_in_reg_disp_sel_yn=>'Y',p_plug_display_point=>'REGION_POSITION_01',p_menu_id=>wwv_flow_api.id(327305317139455601),p_plug_source_type=>'NATIVE_BREADCRUMB',p_menu_template_id=>wwv_flow_api.id(327293780686455585),p_plug_query_options=>'DERIVED_REPORT_COLUMNS');wwv_flow_api.create_page_plug( p_id=>wwv_flow_api.id(781733013379109514),p_plug_name=>'HOME_IMAGE',p_region_template_options=>'#DEFAULT#',p_plug_template=>wwv_flow_api.id(327260456234455539),p_plug_display_sequence=>11,p_include_in_reg_disp_sel_yn=>'N',p_plug_display_point=>'BODY',p_plug_query_row_template=>1,p_plug_query_options=>'DERIVED_REPORT_COLUMNS',p_attribute_01=>'N',p_attribute_02=>'HTML');wwv_flow_api.create_page_button( p_id=>wwv_flow_api.id(386992492640327749),p_button_sequence=>10,p_button_plug_id=>wwv_flow_api.id(344814941748650212),p_button_name=>'START',p_button_action=>'REDIRECT_PAGE',p_button_template_options=>'#DEFAULT#:t-Button--iconRight',p_button_template_id=>wwv_flow_api.id(327293304788455585),p_button_is_hot=>'Y',p_button_image_alt=>'Start Shopping !',p_button_position=>'RIGHT_OF_IR_SEARCH_BAR',p_button_redirect_url=>'f?p=&APP_ID.:1:&SESSION.::&DEBUG.:RP::',p_button_condition=>'select * from apex_collections where collection_name = ''MY_SOCK_COLLECTION''',p_button_condition_type=>'NOT_EXISTS',p_icon_css_classes=>'fa-sun-o');wwv_flow_api.create_page_button( p_id=>wwv_flow_api.id(344815903668650222),p_button_sequence=>20,p_button_plug_id=>wwv_flow_api.id(344814941748650212),p_button_name=>'RESET',p_button_action=>'REDIRECT_URL',p_button_template_options=>'#DEFAULT#',p_button_template_id=>wwv_flow_api.id(327293119580455584),p_button_image_alt=>'Empty my shopping cart',p_button_position=>'RIGHT_OF_IR_SEARCH_BAR',p_button_redirect_url=>'javascript:apex.confirm(''Are you sure you want to reset your shopping cart?'',''RESET'');',p_button_condition=>'select * from apex_collections where collection_name = ''MY_SOCK_COLLECTION'';',p_button_condition_type=>'EXISTS',p_icon_css_classes=>'fa-trash-o');wwv_flow_api.create_page_button( p_id=>wwv_flow_api.id(345817751418557503),p_button_sequence=>30,p_button_plug_id=>wwv_flow_api.id(344814941748650212),p_button_name=>'CREATE',p_button_action=>'SUBMIT',p_button_template_options=>'#DEFAULT#:t-Button--iconRight',p_button_template_id=>wwv_flow_api.id(327293304788455585),p_button_is_hot=>'Y',p_button_image_alt=>'Validate my cart',p_button_position=>'RIGHT_OF_IR_SEARCH_BAR',p_button_condition=>'select * from apex_collections;',p_button_condition_type=>'EXISTS',p_icon_css_classes=>'fa-cart-check');wwv_flow_api.create_page_branch( p_id=>wwv_flow_api.id(345818969488557515),p_branch_name=>'Go To Page 1',p_branch_action=>'f?p=&APP_ID.:18:&SESSION.::&DEBUG.:RP::&success_msg=#SUCCESS_MSG#',p_branch_point=>'AFTER_PROCESSING',p_branch_type=>'REDIRECT_URL',p_branch_when_button_id=>wwv_flow_api.id(345817751418557503),p_branch_sequence=>10);wwv_flow_api.create_page_branch( p_id=>wwv_flow_api.id(382900010938154232),p_branch_action=>'f?p=&APP_ID.:101:&SESSION.::&DEBUG.:RP::&success_msg=#SUCCESS_MSG#',p_branch_point=>'BEFORE_COMPUTATION',p_branch_type=>'REDIRECT_URL',p_branch_when_button_id=>wwv_flow_api.id(345817751418557503),p_branch_sequence=>20,p_branch_condition_type=>'USER_IS_PUBLIC_USER');wwv_flow_api.create_page_item( p_id=>wwv_flow_api.id(345154354106925412),p_name=>'P3_REMOVE_ID',p_item_sequence=>10,p_item_plug_id=>wwv_flow_api.id(344814941748650212),p_display_as=>'NATIVE_HIDDEN',p_attribute_01=>'N');wwv_flow_api.create_page_item( p_id=>wwv_flow_api.id(394740312336781768),p_name=>'P3_HOME_IMAGE',p_item_sequence=>10,p_item_plug_id=>wwv_flow_api.id(781733013379109514),p_source=>'#APP_IMAGES#assorted_socks_2.png',p_source_type=>'STATIC',p_display_as=>'NATIVE_DISPLAY_IMAGE',p_tag_css_classes=>'picture',p_attribute_01=>'URL');wwv_flow_api.create_page_validation( p_id=>wwv_flow_api.id(351686984006319236),p_validation_name=>'Check customer is logged in',p_validation_sequence=>10,p_validation=>wwv_flow_string.join(wwv_flow_t_varchar2('begin','  logger.log(APEX_APPLICATION.g_user);','  if APEX_APPLICATION.g_user != null or APEX_APPLICATION.g_user != ''nobody'' then','        return true;','  else return false;','  end if;','end;')),p_validation_type=>'FUNC_BODY_RETURNING_BOOLEAN',p_error_message=>'Please log in first. ',p_always_execute=>'N',p_validation_condition_type=>'NEVER',p_when_button_pressed=>wwv_flow_api.id(345817751418557503),p_error_display_location=>'INLINE_WITH_FIELD_AND_NOTIFICATION');wwv_flow_api.create_page_da_event( p_id=>wwv_flow_api.id(345153792754925407),p_name=>'Delete_Row',p_event_sequence=>10,p_triggering_element_type=>'ITEM',p_triggering_element=>'P3_REMOVE_ID',p_bind_type=>'bind',p_bind_event_type=>'custom',p_bind_event_type_custom=>'Link_Call');wwv_flow_api.create_page_da_action( p_id=>wwv_flow_api.id(345153901637925408),p_event_id=>wwv_flow_api.id(345153792754925407),p_event_result=>'TRUE',p_action_sequence=>10,p_execute_on_page_init=>'N',p_action=>'NATIVE_EXECUTE_PLSQL_CODE',p_attribute_01=>wwv_flow_string.join(wwv_flow_t_varchar2('declare','begin','  APEX_COLLECTION.DELETE_MEMBER(','        p_collection_name => ''MY_SOCK_COLLECTION'',','        p_seq => :P3_REMOVE_ID);','exception when others then','  logger.log(''Error delete collection''||sqlerrm);','end;')),p_attribute_02=>'P3_REMOVE_ID',p_stop_execution_on_error=>'Y',p_wait_for_result=>'Y');wwv_flow_api.create_page_da_action( p_id=>wwv_flow_api.id(394555734775987625),p_event_id=>wwv_flow_api.id(345153792754925407),p_event_result=>'TRUE',p_action_sequence=>20,p_execute_on_page_init=>'N',p_action=>'NATIVE_JAVASCRIPT_CODE',p_attribute_01=>'document.location.reload() ');wwv_flow_api.create_page_da_action( p_id=>wwv_flow_api.id(345154401221925413),p_event_id=>wwv_flow_api.id(345153792754925407),p_event_result=>'TRUE',p_action_sequence=>30,p_execute_on_page_init=>'N',p_action=>'NATIVE_REFRESH',p_affected_elements_type=>'ITEM',p_affected_elements=>'P3_REMOVE_ID');wwv_flow_api.create_page_da_event( p_id=>wwv_flow_api.id(345157047287925439),p_name=>'on dialog close',p_event_sequence=>20,p_triggering_element_type=>'REGION',p_triggering_region_id=>wwv_flow_api.id(344814941748650212),p_bind_type=>'bind',p_bind_event_type=>'apexafterclosedialog');wwv_flow_api.create_page_da_action( p_id=>wwv_flow_api.id(345157115747925440),p_event_id=>wwv_flow_api.id(345157047287925439),p_event_result=>'TRUE',p_action_sequence=>10,p_execute_on_page_init=>'N',p_action=>'NATIVE_JAVASCRIPT_CODE',p_attribute_01=>'apex.message.showPageSuccess(this.data.successMessage.text)');wwv_flow_api.create_page_da_action( p_id=>wwv_flow_api.id(394554204168987610),p_event_id=>wwv_flow_api.id(345157047287925439),p_event_result=>'TRUE',p_action_sequence=>20,p_execute_on_page_init=>'N',p_action=>'NATIVE_JAVASCRIPT_CODE',p_attribute_01=>'document.location.reload() ');wwv_flow_api.create_page_da_action( p_id=>wwv_flow_api.id(345157202745925441),p_event_id=>wwv_flow_api.id(345157047287925439),p_event_result=>'TRUE',p_action_sequence=>40,p_execute_on_page_init=>'N',p_action=>'NATIVE_REFRESH',p_affected_elements_type=>'REGION',p_affected_region_id=>wwv_flow_api.id(344814941748650212));wwv_flow_api.create_page_da_action( p_id=>wwv_flow_api.id(394554063098987608),p_event_id=>wwv_flow_api.id(345157047287925439),p_event_result=>'TRUE',p_action_sequence=>50,p_execute_on_page_init=>'N',p_action=>'NATIVE_REFRESH',p_affected_elements_type=>'ITEM',p_affected_elements=>'P0_CART_CONTENT');wwv_flow_api.create_page_process( p_id=>wwv_flow_api.id(344816078164650223),p_process_sequence=>10,p_process_point=>'AFTER_SUBMIT',p_process_type=>'NATIVE_PLSQL',p_process_name=>'Empty my shopping cart',p_process_sql_clob=>wwv_flow_string.join(wwv_flow_t_varchar2('declare','begin','  APEX_COLLECTION.CREATE_OR_TRUNCATE_COLLECTION(','    p_collection_name => ''MY_SOCK_COLLECTION'');','end;')),p_error_display_location=>'INLINE_IN_NOTIFICATION',p_process_when_button_id=>wwv_flow_api.id(344815903668650222),p_process_when=>wwv_flow_string.join(wwv_flow_t_varchar2('select c001 as "Name"','from APEX_COLLECTIONS','where collection_name = ''MY_SOCK_COLLECTION'';')),p_process_when_type=>'EXISTS',p_process_success_message=>'Your shopping cart has been successfully emptied.');wwv_flow_api.create_page_process( p_id=>wwv_flow_api.id(345817911411557505),p_process_sequence=>20,p_process_point=>'AFTER_SUBMIT',p_process_type=>'NATIVE_PLSQL',p_process_name=>'Create order',p_process_sql_clob=>wwv_flow_string.join(wwv_flow_t_varchar2('declare','  loc_product_detail_id     SOK_PRODUCT_DETAIL_LIST_VW.product_detail_id%TYPE;','  loc_product_id            SOK_PRODUCT_LIST_VW.product_id%TYPE;','  loc_sex_code              SOK_PRODUCT_DETAIL_LIST_VW.sex_code%TYPE;','  loc_size_range_code       SOK_PRODUCT_DETAIL_LIST_VW.size_range_code%TYPE;','  loc_product_detail_stock  SOK_PRODUCT_DETAIL_LU.product_detail_stock%TYPE;','  loc_quantity              SOK_ORDER_CONTENT.order_product_quantity%TYPE;','  loc_max_seq_id            INTEGER := 0;','  loc_user_id               SOK_USER.user_id%TYPE;','  loc_order_id              SOK_ORDER.order_id%TYPE;','  loc_order_status_code     SOK_ORDER.order_status_code%TYPE := ''PAID'';','  ','begin','    --I resequence all seq_id so that they are all in consecutive order','    APEX_COLLECTION.RESEQUENCE_COLLECTION (','        p_collection_name => ''MY_SOCK_COLLECTION'');','        ','    --I find the highest seq_id and store it into loc_max_seq_id','    select max(seq_id) into loc_max_seq_id','    from apex_collections','    where collection_name = ''MY_SOCK_COLLECTION'';','    ','    --I get user''s id as it is required to create order','    select distinct user_id into loc_user_id','    from SOK_USER_ROLE_VW','    where user_email = upper(APEX_APPLICATION.g_user);','    ','    --function create order returns order_id which is stored in loc_order_id','    loc_order_id := SOK_ORDER_UTIL.c_order(','        val_user_id => loc_user_id,','        val_order_status_code => loc_order_status_code);','   ','  for i in 1..loc_max_seq_id LOOP','    --I store the collection variables into local variables for each seq_id','    select c002, n001, n002, n004 into loc_sex_code, loc_product_id, loc_size_range_code, loc_quantity','    from apex_collections','    where seq_id = i and collection_name = ''MY_SOCK_COLLECTION''; ','       ','    --I get the product_detail_id based on available parameters in order to create order content','    select product_detail_id into loc_product_detail_id','    from SOK_product_detail_list_vw ','    where product_id = loc_product_id and sex_code = loc_sex_code and size_range_code = loc_size_range_code;','    ','    --I create order content','    SOK_ORDER_CONTENT_UTIL.c_order_content(','        val_order_id => loc_order_id,','        val_product_detail_id => loc_product_detail_id,','        val_order_product_quantity => loc_quantity','    );','    --I get the current stock associated with product detail_id in order to update the database','    select product_detail_stock into loc_product_detail_stock','    from sok_product_detail_lu','    where product_detail_id = loc_product_detail_id;','    ','    --I update product detail stock','      SOK_PRODUCT_DETAIL_UTIL.u_product_detail (','      val_product_detail_id => loc_product_detail_id,','      val_size_range_code => loc_size_range_code,','      val_sex_code => loc_sex_code,','      val_product_detail_stock => loc_product_detail_stock-loc_quantity);','  END LOOP;','  ','  --Following the validation of my command I empty my shopping cart','  APEX_COLLECTION.CREATE_OR_TRUNCATE_COLLECTION(','    p_collection_name => ''MY_SOCK_COLLECTION'');','    ','exception when others then','  logger.log_error(''Process "Create order" failed. ''||SQLERRM);','  raise_application_error(-20001, ''Process "Create order" failed. ''||SQLERRM);','end;','')),p_process_error_message=>'Your order could not be registered.',p_error_display_location=>'INLINE_IN_NOTIFICATION',p_process_when_button_id=>wwv_flow_api.id(345817751418557503),p_process_when=>'select * from apex_collections where collection_name = ''MY_SOCK_COLLECTION'';',p_process_when_type=>'EXISTS',p_process_success_message=>'Thank you ! Your order has been successfully registered.');end;/